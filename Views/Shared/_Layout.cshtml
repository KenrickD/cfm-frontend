<!DOCTYPE html>
<html>
<head>
    @Html.Partial("~/Views/Shared/TitleMeta.cshtml")

    @RenderSection("styles", required: false)

    @Html.Partial("~/Views/Shared/HeadCSS.cshtml")

    <script>
        // Apply saved theme immediately on page load (in head to prevent flash)
        (function() {
            // FUTURE: Server-side user preference from database
            // When implemented, set ViewBag.UserThemePreference in BaseController from DB
            var serverTheme = '@ViewBag.UserThemePreference';

            // Priority: localStorage (user's current session choice) > Server DB preference > default (light)
            var savedTheme = localStorage.getItem('pc-theme');

            if (savedTheme && savedTheme !== 'default') {
                // Use localStorage (highest priority - current session choice)
                window.__pendingTheme = savedTheme;
            } else if (serverTheme && serverTheme !== '' && serverTheme !== 'default') {
                // Use server-side DB preference (only if no localStorage override)
                window.__pendingTheme = serverTheme;
                // Sync to localStorage so it persists in current session
                localStorage.setItem('pc-theme', serverTheme);
            }
            // If neither exists, use light mode (app default) - no action needed
        })();
    </script>
</head>
@{
        var layout = ViewBag.LayoutSettings as LayoutSettings;
}
@* <body data-pc-preset="@layout?.PcPreset ?? " preset-1"" data-pc-sidebar-theme="@layout?.PcSidebarTheme ?? " light"" data-pc-sidebar-caption="@layout?.PcSidebarCaption ?? " true"" data-pc-direction="@layout?.PcDirection ?? " ltr"" data-pc-theme="@layout?.PcTheme ?? " light"> *@
@* <body data-pc-preset="@layout.PcPreset" data-pc-sidebar-theme="@layout.PcSidebarTheme" data-pc-sidebar-caption="@layout.PcSidebarCaption" data-pc-direction="@layout.PcDirection" data-pc-theme="@layout.PcTheme"> *@
<body data-pc-preset="@layout.PcPreset" data-pc-sidebar-theme="@layout.PcSidebarTheme" data-pc-sidebar-caption="true" data-pc-direction="ltr" data-pc-theme="light">
    <script>
        // Apply theme immediately now that body exists
        if (window.__pendingTheme) {
            document.body.setAttribute('data-pc-theme', window.__pendingTheme);
            delete window.__pendingTheme;
        }
    </script>

    @Html.Partial("~/Views/Shared/LayoutVertical.cshtml")

    <div class="pc-container">
        <div class="pc-content">

            @Html.Partial("~/Views/Shared/Breadcrumb.cshtml")

            @RenderBody()

        </div>
    </div>

    @RenderSection("externalhtml", required: false)

    @Html.Partial("~/Views/Shared/Footer.cshtml")

    @Html.Partial("~/Views/Shared/Customizer.cshtml")

    @Html.Partial("~/Views/Shared/VendorScripts.cshtml")

    <!-- MVC Endpoints - Centralized endpoint definitions (load before page-specific scripts) -->
    <script src="~/assets/js/mvc-endpoints.js"></script>

    <script>
        // Configure toastr global options
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };

        /**
         * Global notification helper function using toastr
         * Parameters:
         *   - message (string): The message to display
         *   - type (string): Notification type: 'success', 'error', 'warning', 'info'
         *   - title (string): Optional title for the notification
         *   - options (object): Optional toastr options to override defaults
         */
        function showNotification(message, type = 'info', title = '', options = {}) {
            type = type.toLowerCase();

            // Validate type
            if (!['success', 'error', 'warning', 'info'].includes(type)) {
                console.warn('Invalid notification type:', type, '- defaulting to info');
                type = 'info';
            }

            // Call appropriate toastr method
            toastr[type](message, title, options);
        }

        function refreshPrivileges() {
            // Show loading indicator
            showNotification('Refreshing permissions...', 'info', 'Please wait');

            $.ajax({
                url: '@Url.Action("RefreshPrivileges", "Account")',
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        showNotification('Permissions refreshed. Reloading page...', 'success', 'Success');
                        // Reload page after brief delay to show new privileges
                        setTimeout(function() {
                            location.reload();
                        }, 1500);
                    } else {
                        showNotification(response.message || 'Failed to refresh permissions', 'error', 'Error');
                    }
                },
                error: function(xhr, status, error) {
                    showNotification('Network error while refreshing permissions', 'error', 'Error');
                    console.error('Refresh privileges error:', error);
                }
            });
        }
    </script>

    @RenderSection("scripts", required: false)
</body>
</html>
