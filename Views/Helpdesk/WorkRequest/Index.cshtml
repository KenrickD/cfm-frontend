@using cfm_frontend.Extensions
@model cfm_frontend.ViewModels.WorkRequestViewModel
@{
    ViewBag.Title = "Work Request Management";
    ViewBag.pTitle = "Helpdesk";
    ViewBag.cTitle = "List of Work Request";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section styles {
    <link href="~/assets/css/plugins/animate.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="~/assets/css/uikit.css">
    <link rel="stylesheet" href="~/assets/css/components/searchable-dropdown.css">

    <style>
        .modal-footer.no-divider {
            border-top: none;
        }

        .modal-header.no-divider {
            border-bottom: none;
        }

        /* Filter Modal Styles */
        .filter-modal .modal-dialog {
            max-width: 900px;
        }

        .filter-section {
            margin-bottom: 25px;
        }

        .filter-section-title {
            font-weight: 600;
            font-size: 14px;
            color: #04a9f5;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-checkbox-group {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            background-color: #f8f9fa;
        }

        .filter-checkbox-item {
            margin-bottom: 10px;
        }

            .filter-checkbox-item:last-child {
                margin-bottom: 0;
            }

            .filter-checkbox-item .form-check-input {
                margin-top: 0.15em;
            }

            .filter-checkbox-item .form-check-label {
                font-size: 14px;
                cursor: pointer;
            }

        .filter-date-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

            .filter-date-group .form-label {
                min-width: 80px;
                margin-bottom: 0;
                font-weight: 500;
                font-size: 13px;
            }

            .filter-date-group .form-control {
                flex: 1;
            }

        .modal-body {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .btn-clear-filter {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            color: #6c757d;
        }

            .btn-clear-filter:hover {
                background-color: #e2e6ea;
                border-color: #dae0e5;
                color: #545b62;
            }

    </style>
}

<div class="row">
    <!-- [ sample-page ] start -->
    <div class="col-sm-12">
        <div class="card">
            <div class="card-header">
                <h5>@ViewBag.cTitle</h5>
                <p>This table shows all work requests with their codes, titles, requestors, and related details.</p>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <div class="grid gap-0 column-gap-2 d-flex flex-row" style="width: 100%">
                        <div class="input-group w-100">
                            <input placeholder="Search by entering keywords for Work Request Code, Work Title, or Requestor ..."
                                   type="text" class="form-control" id="mainSearchInput" value="@Context.Request.Query["search"]">
                            <button type="button" class="btn btn-light d-flex flex-row align-items-center"
                                    data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top"
                                    data-bs-content="Search" data-bs-trigger="hover" id="searchButton">
                                <i class="ti ti-search"></i>
                            </button>
                            <!-- Filter Button - Opens Modal -->
                            <button type="button" class="btn btn-light d-flex flex-row align-items-center"
                                    data-bs-toggle="modal" data-bs-target="#filterModal"
                                    data-bs-container="body" data-bs-original-title="Advanced Filters">
                                <i class="ti ti-filter"></i>
                            </button>
                            <button type="button" class="btn btn-light d-flex flex-row align-items-center"
                                    data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top"
                                    data-bs-content="Clear Search" data-bs-trigger="hover" id="clearSearchButton">
                                <i class="ti ti-list-search"></i>
                            </button>
                            <button type="button" class="btn btn-light dropdown-toggle d-flex flex-row align-items-center"
                                    data-bs-toggle="dropdown" aria-expanded="false" id="downloadDropdownPopover">
                                <i class="ti ti-cloud-download"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Download as Excel</a></li>
                                <li><a class="dropdown-item" href="#">Download for Updating in Exodus</a></li>
                            </ul>

                            <button type="button" class="btn btn-light d-flex flex-row align-items-center"
                                    data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top"
                                    data-bs-content="Send Summary" data-bs-trigger="hover">
                                <i class="ti ti-mail-forward"></i>
                            </button>
                            @if (Context.Session.CanAdd("Helpdesk", "Work Request Management"))
                            {
                                <a href="@Url.Action("WorkRequestAdd", "Helpdesk")" class="btn btn-light d-flex flex-row align-items-center"
                                   data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top"
                                   data-bs-content="Add New Work Request" data-bs-trigger="hover">
                                    <i class="ti ti-plus"></i>
                                </a>
                            }
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="simpletable" class="table nowrap table-hover m-x-0">
                        <thead>
                            <tr>
                                <th class="text-capitalize">Work Title</th>
                                <th class="text-capitalize">Requested by</th>
                                <th class="text-capitalize">Location</th>
                                <th class="text-capitalize">Work Category</th>
                                <th class="text-capitalize">Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model?.WorkRequest != null && Model.WorkRequest.Any())
                            {
                                @foreach (var workRequest in Model.WorkRequest)
                                {
                                    var statusClass = "";
                                    switch (workRequest.workRequestStatus)
                                    {
                                        case "New":
                                            statusClass = "bg-light-primary";
                                            break;
                                        case "In Progress":
                                            statusClass = "bg-light-success";
                                            break;
                                        case "Completed":
                                            statusClass = "bg-light-secondary";
                                            break;
                                        default:
                                            statusClass = "bg-light";
                                            break;
                                    }
                                    <tr>
                                        <td>
                                            <div class="align-items-center text-wrap" style="width: 250px">
                                                <span>
                                                    <a href="work-requests/@workRequest.idWorkRequest">@workRequest.workRequestCode</a>
                                                    @* <span class="badge" style="background-color: @workRequest.plmColor;">@workRequest.plm</span> *@
                                                </span>
                                                <div>
                                                    <span>@workRequest.workTitle</span>
                                                </div>
                                                @if (workRequest.totalWorker > 0)
                                                {
                                                    <div class="text-muted small">
                                                        <span>Completed by @workRequest.totalWorkerCompleted of @workRequest.totalWorker Workers</span>
                                                    </div>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                @workRequest.fullName @(!string.IsNullOrEmpty(workRequest.requestorDeptName) ? $"({workRequest.requestorDeptName})" : "")
                                            </div>
                                            <div class="text-muted small">
                                                On @workRequest.requestDate.ToString("dd MMM yyyy hh:mm tt")
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column" style="width: 200px">
                                                @if (!string.IsNullOrEmpty(workRequest.propertyName))
                                                {
                                                    <span class="text-wrap">@workRequest.propertyName</span>
                                                }
                                                @{
                                                    var locationParts = new List<string>();
                                                    if (!string.IsNullOrEmpty(workRequest.floorProp))
                                                    {
                                                        locationParts.Add(workRequest.floorProp);
                                                    }
                                                    if (!string.IsNullOrEmpty(workRequest.roomZoneName))
                                                    {
                                                        locationParts.Add(workRequest.roomZoneName);
                                                    }
                                                    if (locationParts.Any())
                                                    {
                                                        <span class="text-wrap">@string.Join(", ", locationParts)</span>
                                                    }
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <span>@workRequest.workCategoryName</span>
                                                <span>Service Provider: @workRequest.serviceProviderName</span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column align-items-start">
                                                <span class="badge @statusClass">@workRequest.workRequestStatus</span>
                                                @if (workRequest.totalHasSentEmail > 0)
                                                {
                                                    <div class="mt-1">
                                                        <i class="ti ti-mail text-primary" style="font-size: 18px;" title="Email sent"></i>
                                                    </div>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <div class="grid gap-0 column-gap-2 d-flex flex-row">
                                                @if (Context.Session.CanEdit("Helpdesk", "Work Request Management"))
                                                {
                                                    <a class="btn btn-light btn-sm" href="#" role="button" data-bs-container="body"
                                                       data-bs-toggle="popover" data-bs-placement="top"
                                                       data-bs-content="Edit this Work Request" data-bs-trigger="hover">
                                                        <i class="ti ti-edit-circle"></i>
                                                    </a>
                                                }
                                                @if (Context.Session.CanDelete("Helpdesk", "Work Request Management"))
                                                {
                                                    <button data-pc-animate="blur" type="button" class="btn btn-light btn-sm" data-bs-toggle="modal"
                                                            data-bs-target="#deleteModal">
                                                        <i class="ti ti-trash"></i>
                                                    </button>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="ti ti-inbox" style="font-size: 48px; opacity: 0.5;"></i>
                                            <p class="mt-2">No work requests found</p>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @* Pagination Component *@
                @await Html.PartialAsync("_Pagination", Model.Paging)
            </div>
        </div>
    </div>
    <!-- [ sample-page ] end -->
</div>

<!-- Filter Modal - DATA IS LOADED FROM SERVER (Model) -->
<div class="modal fade filter-modal" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">
                    <i class="ti ti-filter me-2"></i>Advanced Filters
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="filterForm">
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <!-- Property Group - FROM SERVER -->
                            <div class="filter-section">
                                <label class="filter-section-title">Property Group</label>
                                <select class="form-select"
                                        id="filterPropertyGroup"
                                        name="propertyGroup"
                                        data-searchable="true"
                                        data-placeholder="All Property Groups"
                                        data-search-placeholder="Search property group...">
                                    <option value="">All</option>
                                    @if (Model?.FilterOptions?.PropertyGroups != null)
                                    {
                                        @foreach (var group in Model.FilterOptions.PropertyGroups)
                                        {
                                            <option value="@group.propertyGroupId">@group.propertyGroupName</option>
                                        }
                                    }
                                </select>
                            </div>

                            <!-- Location - FROM SERVER -->
                            <div class="filter-section">
                                <label class="filter-section-title">Location</label>
                                <div class="filter-checkbox-group">
                                    @if (Model?.FilterOptions?.Locations != null && Model.FilterOptions.Locations.Any())
                                    {
                                        @foreach (var location in Model.FilterOptions.Locations)
                                        {
                                            <div class="filter-checkbox-item form-check">
                                                <input class="form-check-input" type="checkbox" value="@location.idProperty" id="loc_@location.idProperty" name="locations">
                                                <label class="form-check-label" for="loc_@location.idProperty">
                                                    @location.propertyName
                                                </label>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center text-muted py-2">
                                            <small>No locations available</small>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Service Provider - FROM SERVER -->
                            <div class="filter-section">
                                <label class="filter-section-title">Service Provider</label>
                                <div class="filter-checkbox-group">
                                    @if (Model?.FilterOptions?.ServiceProviders != null && Model.FilterOptions.ServiceProviders.Any())
                                    {
                                        @foreach (var provider in Model.FilterOptions.ServiceProviders)
                                        {
                                            <div class="filter-checkbox-item form-check">
                                                <input class="form-check-input" type="checkbox" value="@provider.id" id="sp_@provider.id" name="serviceProviders">
                                                <label class="form-check-label" for="sp_@provider.id">
                                                    @provider.name
                                                </label>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center text-muted py-2">
                                            <small>No service providers available</small>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Room Zone - FROM SERVER -->
                            <div class="filter-section">
                                <label class="filter-section-title">Room Zone</label>
                                <select class="form-select"
                                        id="filterRoomZone"
                                        name="roomZone"
                                        data-searchable="true"
                                        data-placeholder="All Room Zones"
                                        data-search-placeholder="Search room zone...">
                                    <option value="">All</option>
                                    @if (Model?.FilterOptions?.RoomZones != null)
                                    {
                                        @foreach (var zone in Model.FilterOptions.RoomZones)
                                        {
                                            <option value="@zone.Id">@zone.Name</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-6">
                            <!-- Work Category - FROM SERVER -->
                            <div class="filter-section">
                                <label class="filter-section-title">Work Category</label>
                                <div class="filter-checkbox-group">
                                    @if (Model?.FilterOptions?.WorkCategories != null && Model.FilterOptions.WorkCategories.Any())
                                    {
                                        @foreach (var category in Model.FilterOptions.WorkCategories)
                                        {
                                            <div class="filter-checkbox-item form-check">
                                                <input class="form-check-input" type="checkbox" value="@category.id" id="wc_@category.id" name="workCategories">
                                                <label class="form-check-label" for="wc_@category.id">
                                                    @category.name
                                                </label>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center text-muted py-2">
                                            <small>No work categories available</small>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Other Category - FROM SERVER -->
                            <div class="filter-section">
                                <label class="filter-section-title">Other Category</label>
                                <div class="filter-checkbox-group">
                                    @if (Model?.FilterOptions?.OtherCategories != null && Model.FilterOptions.OtherCategories.Any())
                                    {
                                        @foreach (var category in Model.FilterOptions.OtherCategories)
                                        {
                                            <div class="filter-checkbox-item form-check">
                                                <input class="form-check-input" type="checkbox" value="@category.id" id="oc_@category.id" name="otherCategories">
                                                <label class="form-check-label" for="oc_@category.id">
                                                    @category.name
                                                </label>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center text-muted py-2">
                                            <small>No other categories available</small>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Priority Level - FROM SERVER -->
                            <div class="filter-section">
                                <label class="filter-section-title">Priority Level</label>
                                <div class="filter-checkbox-group">
                                    @if (Model?.FilterOptions?.PriorityLevels != null && Model.FilterOptions.PriorityLevels.Any())
                                    {
                                        @foreach (var priority in Model.FilterOptions.PriorityLevels)
                                        {
                                            <div class="filter-checkbox-item form-check">
                                                <input class="form-check-input" type="checkbox" value="@priority.Value" id="priority_@priority.Value" name="priorities">
                                                <label class="form-check-label" for="priority_@priority.Value">
                                                    @priority.Label
                                                </label>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Full Width Sections -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <!-- Status - FROM SERVER -->
                            <div class="filter-section">
                                <label class="filter-section-title">Status</label>
                                <div class="filter-checkbox-group">
                                    @if (Model?.FilterOptions?.Statuses != null && Model.FilterOptions.Statuses.Any())
                                    {
                                        @foreach (var status in Model.FilterOptions.Statuses)
                                        {
                                            <div class="filter-checkbox-item form-check">
                                                <input class="form-check-input" type="checkbox" value="@status.Value" id="status_@status.Value" name="statuses">
                                                <label class="form-check-label" for="status_@status.Value">
                                                    @status.Label
                                                </label>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>

                            <!-- Request Date -->
                            <div class="filter-section">
                                <label class="filter-section-title">Request Date</label>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="filter-date-group">
                                            <label class="form-label">From:</label>
                                            <input type="date" class="form-control" id="requestDateFrom" name="requestDateFrom">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="filter-date-group">
                                            <label class="form-label">To:</label>
                                            <input type="date" class="form-control" id="requestDateTo" name="requestDateTo">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Work Completion Date -->
                            <div class="filter-section">
                                <label class="filter-section-title">Work Completion Date</label>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="filter-date-group">
                                            <label class="form-label">From:</label>
                                            <input type="date" class="form-control" id="workCompletionDateFrom" name="workCompletionDateFrom">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="filter-date-group">
                                            <label class="form-label">To:</label>
                                            <input type="date" class="form-control" id="workCompletionDateTo" name="workCompletionDateTo">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Important Checklist - FROM SERVER -->
                            <div class="filter-section">
                                <label class="filter-section-title">Important Checklist</label>
                                <div class="filter-checkbox-group">
                                    @if (Model?.FilterOptions?.ImportantChecklists != null && Model.FilterOptions.ImportantChecklists.Any())
                                    {
                                        @foreach (var item in Model.FilterOptions.ImportantChecklists)
                                        {
                                            <div class="filter-checkbox-item form-check">
                                                <input class="form-check-input" type="checkbox" value="@item.Value" id="checklist_@item.Value" name="checklist">
                                                <label class="form-check-label" for="checklist_@item.Value">
                                                    @item.Label
                                                </label>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>

                            <!-- Feedback Type - FROM SERVER -->
                            <div class="filter-section">
                                <label class="filter-section-title">Feedback Type</label>
                                <div class="filter-checkbox-group">
                                    @if (Model?.FilterOptions?.FeedbackTypes != null && Model.FilterOptions.FeedbackTypes.Any())
                                    {
                                        @foreach (var fb in Model.FilterOptions.FeedbackTypes)
                                        {
                                            <div class="filter-checkbox-item form-check">
                                                <input class="form-check-input" type="checkbox" value="@fb.Value" id="feedback_@fb.Value" name="feedback">
                                                <label class="form-check-label" for="feedback_@fb.Value">
                                                    @fb.Label
                                                </label>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>

                            <!-- Has Sent Email - STATIC -->
                            <div class="filter-section">
                                <label class="filter-section-title">Has Sent Email</label>
                                <div class="filter-checkbox-group">
                                    <div class="filter-checkbox-item form-check">
                                        <input class="form-check-input" type="checkbox" value="yes" id="emailYes" name="hasSentEmail">
                                        <label class="form-check-label" for="emailYes">Yes</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Show Deleted Data - STATIC -->
                            <div class="filter-section">
                                <label class="filter-section-title">Show Deleted Data</label>
                                <div class="filter-checkbox-group">
                                    <div class="filter-checkbox-item form-check">
                                        <input class="form-check-input" type="checkbox" value="yes" id="showDeleted" name="showDeleted">
                                        <label class="form-check-label" for="showDeleted">Yes</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-clear-filter" id="clearFiltersBtn">
                    <i class="ti ti-x me-1"></i>Clear All Filters
                </button>
                <button type="button" class="btn btn-primary" id="applyFiltersBtn">
                    <i class="ti ti-check me-1"></i>Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade modal-animate" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header no-divider">
                <div class="d-flex flex-row align-items-center text-danger">
                    <i class="ti ti-alert-octagon me-2 fs-5"></i>
                    <span class="text-lg fw-semibold">Warning</span>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>You are about to delete Work Request &mdash; WR-1234567</h5>
                <p>Are you sure you want to delete this Work Request? This action cannot be undone.</p>
            </div>
            <div class="modal-footer no-divider bg-gray-100">
                <div class="container-fluid">
                    <div class="d-flex align-items-center justify-content-between gap-3">
                        <button type="button" class="btn btn-outline-secondary rounded-3 w-100 d-flex justify-content-center align-items-center" data-bs-dismiss="modal">
                            <i class="ti ti-x me-2"></i>
                            Cancel
                        </button>
                        <button type="button" class="btn btn-danger rounded-3 w-100 d-flex justify-content-center align-items-center">
                            <i class="ti ti-trash me-2"></i>
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="~/assets/js/components/searchable-dropdown.js"></script>

    <script>
        $(document).ready(function () {
            // Initialize popovers
            $('[data-bs-toggle="popover"]').popover({
                container: 'body',
                placement: 'top',
                trigger: 'hover'
            });

            // Delete Modal Animation
            var deleteModal = $('#deleteModal');
            deleteModal.on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var recipient = button.data('pc-animate');
                deleteModal.addClass('anim-' + recipient);
                if (recipient == 'let-me-in' || recipient == 'make-way' || recipient == 'slip-from-top') {
                    $('body').addClass('anim-' + recipient);
                }
            });

            deleteModal.on('hidden.bs.modal', function () {
                removeClassByPrefix(deleteModal, 'anim-');
                removeClassByPrefix($('body'), 'anim-');
            });

            function removeClassByPrefix(node, prefix) {
                node.removeClass(function (index, className) {
                    return (className.match(new RegExp('\\b' + prefix + '\\S+', 'g')) || []).join(' ');
                });
            }


            // Clear all filters
            $('#clearFiltersBtn').on('click', function() {
                $('#filterForm')[0].reset();
                $('#filterForm input[type="checkbox"]').prop('checked', false);
                $('#filterPropertyGroup').val('');
                $('#filterRoomZone').val('');

                // Redirect to clean URL (preserving search if exists)
                var searchTerm = $('#mainSearchInput').val();
                var url = new URL(window.location.origin + '/Helpdesk/Index');
                if (searchTerm && searchTerm.trim() !== '') {
                    url.searchParams.set('search', searchTerm.trim());
                }
                window.location.href = url.toString();
            });

            // Apply filters
            $('#applyFiltersBtn').on('click', function() {
                // Collect all filter values
                var filters = {
                    propertyGroup: $('#filterPropertyGroup').val(),
                    roomZone: $('#filterRoomZone').val(),
                    locations: $('input[name="locations"]:checked').map(function() { return this.value; }).get(),
                    serviceProviders: $('input[name="serviceProviders"]:checked').map(function() { return this.value; }).get(),
                    workCategories: $('input[name="workCategories"]:checked').map(function() { return this.value; }).get(),
                    otherCategories: $('input[name="otherCategories"]:checked').map(function() { return this.value; }).get(),
                    priorities: $('input[name="priorities"]:checked').map(function() { return this.value; }).get(),
                    statuses: $('input[name="statuses"]:checked').map(function() { return this.value; }).get(),
                    requestDateFrom: $('#requestDateFrom').val(),
                    requestDateTo: $('#requestDateTo').val(),
                    workCompletionDateFrom: $('#workCompletionDateFrom').val(),
                    workCompletionDateTo: $('#workCompletionDateTo').val(),
                    checklist: $('input[name="checklist"]:checked').map(function() { return this.value; }).get(),
                    feedback: $('input[name="feedback"]:checked').map(function() { return this.value; }).get(),
                    hasSentEmail: $('#emailYes').is(':checked'),
                    showDeleted: $('#showDeleted').is(':checked')
                };

                // Build query string from filters
                var url = new URL(window.location.origin + '/Helpdesk/Index');

                // Add single-value filters
                if (filters.propertyGroup) url.searchParams.set('propertyGroup', filters.propertyGroup);
                if (filters.roomZone) url.searchParams.set('roomZone', filters.roomZone);
                if (filters.requestDateFrom) url.searchParams.set('requestDateFrom', filters.requestDateFrom);
                if (filters.requestDateTo) url.searchParams.set('requestDateTo', filters.requestDateTo);
                if (filters.workCompletionDateFrom) url.searchParams.set('workCompletionDateFrom', filters.workCompletionDateFrom);
                if (filters.workCompletionDateTo) url.searchParams.set('workCompletionDateTo', filters.workCompletionDateTo);
                if (filters.hasSentEmail) url.searchParams.set('hasSentEmail', 'true');
                if (filters.showDeleted) url.searchParams.set('showDeleted', 'true');

                // Add multi-value filters (arrays)
                filters.locations.forEach(id => url.searchParams.append('locations', id));
                filters.serviceProviders.forEach(id => url.searchParams.append('serviceProviders', id));
                filters.workCategories.forEach(id => url.searchParams.append('workCategories', id));
                filters.otherCategories.forEach(id => url.searchParams.append('otherCategories', id));
                filters.priorities.forEach(p => url.searchParams.append('priorities', p));
                filters.statuses.forEach(s => url.searchParams.append('statuses', s));
                filters.checklist.forEach(c => url.searchParams.append('checklist', c));
                filters.feedback.forEach(f => url.searchParams.append('feedback', f));

                // Preserve search term if exists
                var searchTerm = $('#mainSearchInput').val();
                if (searchTerm && searchTerm.trim() !== '') {
                    url.searchParams.set('search', searchTerm.trim());
                }

                // Reset to page 1 when filters change
                url.searchParams.set('page', '1');

                // Navigate to filtered URL
                window.location.href = url.toString();
            });

            // Main search button
            $('#searchButton').on('click', function() {
                var searchTerm = $('#mainSearchInput').val();
                var currentUrl = new URL(window.location.href);

                if (searchTerm && searchTerm.trim() !== '') {
                    currentUrl.searchParams.set('search', searchTerm.trim());
                } else {
                    currentUrl.searchParams.delete('search');
                }

                // Reset to page 1 when searching
                currentUrl.searchParams.delete('page');

                window.location.href = currentUrl.toString();
            });

            // Allow Enter key to trigger search
            $('#mainSearchInput').on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    $('#searchButton').click();
                }
            });

            // Clear search button
            $('#clearSearchButton').on('click', function() {
                $('#mainSearchInput').val('');
                var currentUrl = new URL(window.location.href);
                currentUrl.searchParams.delete('search');
                currentUrl.searchParams.delete('page');
                window.location.href = currentUrl.toString();
            });

            // Restore filter state from URL query string
            function getQueryParam(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.getAll(name);
            }

            // Restore single-value dropdowns
            const propertyGroup = getQueryParam('propertyGroup')[0];
            if (propertyGroup) $('#filterPropertyGroup').val(propertyGroup);

            const roomZone = getQueryParam('roomZone')[0];
            if (roomZone) $('#filterRoomZone').val(roomZone);

            // Restore multi-select checkboxes
            const locations = getQueryParam('locations');
            locations.forEach(id => $(`input[name="locations"][value="${id}"]`).prop('checked', true));

            const serviceProviders = getQueryParam('serviceProviders');
            serviceProviders.forEach(id => $(`input[name="serviceProviders"][value="${id}"]`).prop('checked', true));

            const workCategories = getQueryParam('workCategories');
            workCategories.forEach(id => $(`input[name="workCategories"][value="${id}"]`).prop('checked', true));

            const otherCategories = getQueryParam('otherCategories');
            otherCategories.forEach(id => $(`input[name="otherCategories"][value="${id}"]`).prop('checked', true));

            const priorities = getQueryParam('priorities');
            priorities.forEach(p => $(`input[name="priorities"][value="${p}"]`).prop('checked', true));

            const statuses = getQueryParam('statuses');
            statuses.forEach(s => $(`input[name="statuses"][value="${s}"]`).prop('checked', true));

            const checklist = getQueryParam('checklist');
            checklist.forEach(c => $(`input[name="checklist"][value="${c}"]`).prop('checked', true));

            const feedback = getQueryParam('feedback');
            feedback.forEach(f => $(`input[name="feedback"][value="${f}"]`).prop('checked', true));

            // Restore date inputs
            const requestDateFrom = getQueryParam('requestDateFrom')[0];
            if (requestDateFrom) $('#requestDateFrom').val(requestDateFrom);

            const requestDateTo = getQueryParam('requestDateTo')[0];
            if (requestDateTo) $('#requestDateTo').val(requestDateTo);

            const workCompletionDateFrom = getQueryParam('workCompletionDateFrom')[0];
            if (workCompletionDateFrom) $('#workCompletionDateFrom').val(workCompletionDateFrom);

            const workCompletionDateTo = getQueryParam('workCompletionDateTo')[0];
            if (workCompletionDateTo) $('#workCompletionDateTo').val(workCompletionDateTo);

            // Restore single checkboxes
            const hasSentEmail = getQueryParam('hasSentEmail')[0];
            if (hasSentEmail === 'true') $('#emailYes').prop('checked', true);

            const showDeleted = getQueryParam('showDeleted')[0];
            if (showDeleted === 'true') $('#showDeleted').prop('checked', true);
        });
    </script>
}
