@model cfm_frontend.ViewModels.WorkRequestViewModel

@{
    ViewBag.Title = "Add New Work Request";
    ViewBag.pTitle = "Helpdesk";
    ViewBag.cTitle = "Add New Work Request";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section styles {
    <link rel="stylesheet" href="~/assets/css/plugins/datepicker-bs5.min.css">
    <link rel="stylesheet" href="~/assets/css/components/searchable-dropdown.css">

    <style>
        .required-field::after {
            content: " *";
            color: #dc3545;
        }

        .form-control-sm, .form-select-sm {
            font-size: 0.875rem;
        }

        .target-time-display {
            background-color: #e7f3ff;
            border: 1px solid #04a9f5;
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s;
        }

            .target-time-display:hover {
                background-color: #d0ebff;
            }

        .target-change-form {
            display: none;
            margin-top: 0.5rem;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .datetime-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

            .datetime-group input[type="date"],
            .datetime-group input[type="time"] {
                flex: 1;
            }

        .location-search-wrapper {
            position: relative;
        }

        .typeahead-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

            .typeahead-dropdown.show {
                display: block;
            }

        .typeahead-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

            .typeahead-item:hover {
                background-color: #f8f9fa;
            }

            .typeahead-item:last-child {
                border-bottom: none;
            }

        .labor-material-table {
            margin-top: 1rem;
        }

        .btn-add-labor {
            background-color: #04a9f5;
            color: white;
            border: none;
        }

            .btn-add-labor:hover {
                background-color: #0396de;
                color: white;
            }
    </style>
}

<div class="row">
    <div class="col-sm-12">
        <!-- Page Header -->
        <div class="page-header-title mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="m-b-10">@ViewBag.cTitle</h5>
                    <p class="m-b-0 text-muted">Fill in the details to create a new work request</p>
                </div>
                <div>
                    <a href="/Helpdesk/Index" class="btn btn-outline-secondary btn-sm">
                        <i class="ti ti-arrow-left me-1"></i>
                        Back to List
                    </a>
                </div>
            </div>
        </div>

        <form id="workRequestForm" method="post" action="/Helpdesk/WorkRequestAdd">
            @Html.AntiForgeryToken()

            <!-- Work Request Code (Auto-generated) -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Work Request Code</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-0">
                        <i class="ti ti-info-circle me-2"></i>
                        Work Request Code will be created after you save this request
                    </div>
                </div>
            </div>

            <!-- Location Details -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-1">Location Details</h5>
                    <p class="text-muted mb-0 small">Specify where the work needs to be done</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Location Searchable Dropdown -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold required-field">Location</label>
                            <select class="form-select form-select-sm"
                                    id="locationSelect"
                                    name="IdLocation"
                                    data-searchable="true"
                                    data-placeholder="Select Location"
                                    data-search-placeholder="Search location..."
                                    required>
                                <option value="">Select Location</option>
                                <!-- Options loaded dynamically via JavaScript -->
                            </select>
                        </div>

                        <!-- Floor -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold required-field">Floor</label>
                            <select class="form-select form-select-sm"
                                    id="floorSelect"
                                    name="IdFloor"
                                    data-searchable="true"
                                    data-placeholder="Select Floor"
                                    data-search-placeholder="Search floor..."
                                    required
                                    disabled>
                                <option value="">Select Floor</option>
                            </select>
                        </div>

                        <!-- Room/Area/Zone -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold required-field">Room/Area/Zone</label>
                            <select class="form-select form-select-sm"
                                    id="roomSelect"
                                    name="IdRoom"
                                    data-searchable="true"
                                    data-placeholder="Select Room/Area/Zone"
                                    data-search-placeholder="Search room..."
                                    required
                                    disabled>
                                <option value="">Select Room/Area/Zone</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requestor and Work Details -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-1">Requestor and Work Details</h5>
                    <p class="text-muted mb-0 small">Provide details about who requested and what work is needed</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Requestor Name -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-semibold required-field">Requestor Name</label>
                            <input type="text"
                                   class="form-control form-control-sm"
                                   id="requestorSearch"
                                   name="RequestorName"
                                   placeholder="Type to search requestor..."
                                   autocomplete="off"
                                   required>
                            <div id="requestorDropdown" class="typeahead-dropdown"></div>
                            <input type="hidden" id="requestorId" name="IdRequestor">
                        </div>

                        <!-- Work Title -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-semibold required-field">Work Title</label>
                            <input type="text"
                                   class="form-control form-control-sm"
                                   id="workTitle"
                                   name="WorkTitle"
                                   placeholder="Brief description of the work"
                                   required
                                   maxlength="200">
                        </div>

                        <!-- Request Detail -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold required-field">Request Detail</label>
                            <textarea class="form-control form-control-sm"
                                      id="requestDetail"
                                      name="RequestDetail"
                                      rows="5"
                                      placeholder="Explain the user's request, issue, or question in detail"
                                      required></textarea>
                        </div>

                        <!-- Solution -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Solution</label>
                            <textarea class="form-control form-control-sm"
                                      id="solution"
                                      name="Solution"
                                      rows="5"
                                      placeholder="Detail the steps or solutions provided to resolve the request"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Request Method and Status -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-1">Request Method and Status</h5>
                    <p class="text-muted mb-0 small">How was this request received</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Request Method -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold required-field">Request Method</label>
                            <div class="mt-2">
                                <!-- Radio buttons loaded dynamically via JavaScript -->
                            </div>
                        </div>

                        <!-- Status -->`
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold required-field">Status</label>
                            <div class="mt-2">
                                <!-- Radio buttons loaded dynamically via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Work Categories -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-1">Work Categories</h5>
                    <p class="text-muted mb-0 small">Categorize this work request</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Work Category -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold required-field">Work Category</label>
                            <select class="form-select form-select-sm"
                                    id="workCategorySelect"
                                    name="IdWorkCategory"
                                    data-searchable="true"
                                    data-placeholder="Select Work Category"
                                    data-search-placeholder="Search category..."
                                    required>
                                <option value="">Select Work Category</option>
                                <!-- Options loaded dynamically via JavaScript -->
                            </select>
                        </div>

                        <!-- Other Category -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Other Category</label>
                            <select class="form-select form-select-sm"
                                    id="otherCategorySelect"
                                    name="IdOtherCategory"
                                    data-searchable="true"
                                    data-placeholder="Select Other Category"
                                    data-search-placeholder="Search category...">
                                <option value="">Select Other Category</option>
                                <!-- Options loaded dynamically via JavaScript -->
                            </select>
                        </div>

                        <!-- Other Category 2 -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Other Category 2</label>
                            <select class="form-select form-select-sm"
                                    id="otherCategory2Select"
                                    name="IdOtherCategory2"
                                    data-searchable="true"
                                    data-placeholder="Select Other Category 2"
                                    data-search-placeholder="Search category...">
                                <option value="">Select Other Category 2</option>
                                <!-- Options loaded dynamically via JavaScript -->
                            </select>
                        </div>

                        <!-- PM Finding Checkbox -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-semibold">This WR is based on PM Finding</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="pmFindingCheck" name="IsPMFinding" value="true">
                                <label class="form-check-label" for="pmFindingCheck">
                                    Yes, this work request is based on Preventive Maintenance finding
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Person in Charge and Worker -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-1">Person in Charge and Worker</h5>
                    <p class="text-muted mb-0 small">Assign responsible persons</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Person in Charge -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold required-field">Person in Charge</label>
                            <select class="form-select form-select-sm"
                                    id="personInChargeSelect"
                                    name="IdPersonInCharge"
                                    data-searchable="true"
                                    data-placeholder="Select Person in Charge"
                                    data-search-placeholder="Search person..."
                                    required>
                                <option value="">Select Person in Charge</option>
                            </select>
                        </div>

                        <!-- Service Provider -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Service Provider</label>
                            <select class="form-select form-select-sm"
                                    id="serviceProviderSelect"
                                    name="IdServiceProvider"
                                    data-searchable="true"
                                    data-placeholder="Select Service Provider"
                                    data-search-placeholder="Search provider...">
                                <option value="">Select Service Provider</option>
                                <!-- Options loaded dynamically via JavaScript -->
                            </select>
                        </div>

                        <!-- Workers Table -->
                        <div class="col-md-12 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-semibold">Workers</label>
                                <button type="button" class="btn btn-sm btn-primary" id="addWorkerBtn">
                                    <i class="ti ti-plus me-1"></i>Add Worker
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm" id="workersTable">
                                    <thead>
                                        <tr>
                                            <th width="40%">Worker Name</th>
                                            <th width="30%">Source</th>
                                            <th width="20%">Join Chat Room</th>
                                            <th width="10%">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                <em>No workers added yet</em>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Important Checklist -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-1">Important Checklist</h5>
                    <p class="text-muted mb-0 small">Safety and operational requirements</p>
                </div>
                <div class="card-body">
                    <div class="row" id="importantChecklistContainer">
                        <!-- Checklist items loaded dynamically with data-type-id attributes -->
                    </div>
                </div>
            </div>

            <!-- Labor/Material -->
            <div class="card mb-3">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">Labor/Material</h5>
                            <p class="text-muted mb-0 small">Add labor and material costs</p>
                        </div>
                        <button type="button" class="btn btn-sm btn-add-labor" id="addLaborMaterialBtn">
                            <i class="ti ti-plus me-1"></i>
                            Add Labor/Material
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive labor-material-table">
                        <table class="table table-bordered table-sm" id="laborMaterialTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th width="12%">Transaction Date</th>
                                    <th width="10%">Qty</th>
                                    <th width="12%">Unit</th>
                                    <th width="15%">Unit Price</th>
                                    <th width="15%">Total</th>
                                    <th width="5%">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <em>No Labor/Material added yet</em>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Cost Estimation -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-1">Cost Estimation</h5>
                    <p class="text-muted mb-0 small">Estimated cost with currency selection</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Currency</label>
                            <select class="form-select form-select-sm"
                                    id="costEstimationCurrencySelect"
                                    name="CostEstimationCurrency"
                                    data-searchable="true"
                                    data-placeholder="Select Currency"
                                    data-search-placeholder="Search currency...">
                                <option value="">Select Currency</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Cost Estimation</label>
                            <input type="number"
                                   class="form-control form-control-sm"
                                   id="costEstimation"
                                   name="CostEstimation"
                                   placeholder="0"
                                   min="0"
                                   step="1000">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline and Dates -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-1">Timeline and Dates</h5>
                    <p class="text-muted mb-0 small">Schedule and target dates for this work request</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Priority Level -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold required-field">Priority Level</label>
                            <select class="form-select form-select-sm"
                                    id="priorityLevelSelect"
                                    name="PriorityLevel"
                                    data-searchable="true"
                                    data-placeholder="Select Priority Level"
                                    data-search-placeholder="Search priority..."
                                    required>
                                <option value="">Select Priority Level</option>
                                <!-- Options loaded dynamically via JavaScript -->
                            </select>
                        </div>

                        <!-- Request Date -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold required-field">Request Date</label>
                            <div class="datetime-group">
                                <input type="date"
                                       class="form-control form-control-sm"
                                       id="requestDate"
                                       name="RequestDate"
                                       required>
                                <input type="time"
                                       class="form-control form-control-sm"
                                       id="requestTime"
                                       name="RequestTime"
                                       required>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <!-- Placeholder for alignment -->
                        </div>

                        <!-- Helpdesk Response -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Helpdesk Response</label>
                            <div class="datetime-group">
                                <input type="date" class="form-control form-control-sm" id="helpdeskResponseDate" name="HelpdeskResponseDate">
                                <input type="time" class="form-control form-control-sm" id="helpdeskResponseTime" name="HelpdeskResponseTime">
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">New Target</label>
                            <div id="helpdeskTarget" class="target-time-display" data-target-type="helpdesk">
                                <i class="ti ti-target me-1"></i>
                                <span class="target-date">-</span>
                            </div>
                            <div class="target-change-form" id="helpdeskTargetForm">
                                <input type="datetime-local" class="form-control form-control-sm mb-2" id="helpdeskNewTarget">
                                <input type="text" class="form-control form-control-sm mb-2" placeholder="Remark" id="helpdeskRemark">
                                <button type="button" class="btn btn-sm btn-primary me-2" onclick="saveTarget('helpdesk')">Save</button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelTarget('helpdesk')">Cancel</button>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Remark</label>
                            <input type="text" class="form-control form-control-sm" id="helpdeskRemarkDisplay" readonly>
                        </div>

                        <!-- Initial Follow Up -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Initial Follow Up</label>
                            <div class="datetime-group">
                                <input type="date" class="form-control form-control-sm" id="initialFollowUpDate" name="InitialFollowUpDate">
                                <input type="time" class="form-control form-control-sm" id="initialFollowUpTime" name="InitialFollowUpTime">
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Target</label>
                            <div id="initialFollowUpTarget" class="target-time-display" data-target-type="initialFollowUp">
                                <i class="ti ti-target me-1"></i>
                                <span class="target-date">-</span>
                            </div>
                            <div class="target-change-form" id="initialFollowUpTargetForm">
                                <input type="datetime-local" class="form-control form-control-sm mb-2" id="initialFollowUpNewTarget">
                                <input type="text" class="form-control form-control-sm mb-2" placeholder="Remark" id="initialFollowUpRemark">
                                <button type="button" class="btn btn-sm btn-primary me-2" onclick="saveTarget('initialFollowUp')">Save</button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelTarget('initialFollowUp')">Cancel</button>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <!-- Placeholder -->
                        </div>

                        <!-- Quotation Submission -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Quotation Submission</label>
                            <div class="datetime-group">
                                <input type="date" class="form-control form-control-sm" id="quotationSubmissionDate" name="QuotationSubmissionDate">
                                <input type="time" class="form-control form-control-sm" id="quotationSubmissionTime" name="QuotationSubmissionTime">
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Target</label>
                            <div id="quotationTarget" class="target-time-display" data-target-type="quotation">
                                <i class="ti ti-target me-1"></i>
                                <span class="target-date">-</span>
                            </div>
                            <div class="target-change-form" id="quotationTargetForm">
                                <input type="datetime-local" class="form-control form-control-sm mb-2" id="quotationNewTarget">
                                <input type="text" class="form-control form-control-sm mb-2" placeholder="Remark" id="quotationRemark">
                                <button type="button" class="btn btn-sm btn-primary me-2" onclick="saveTarget('quotation')">Save</button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelTarget('quotation')">Cancel</button>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <!-- Placeholder -->
                        </div>

                        <!-- Cost Approval -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Cost Approval</label>
                            <div class="datetime-group">
                                <input type="date" class="form-control form-control-sm" id="costApprovalDate" name="CostApprovalDate">
                                <input type="time" class="form-control form-control-sm" id="costApprovalTime" name="CostApprovalTime">
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Target</label>
                            <div id="costApprovalTarget" class="target-time-display" data-target-type="costApproval">
                                <i class="ti ti-target me-1"></i>
                                <span class="target-date">-</span>
                            </div>
                            <div class="target-change-form" id="costApprovalTargetForm">
                                <input type="datetime-local" class="form-control form-control-sm mb-2" id="costApprovalNewTarget">
                                <input type="text" class="form-control form-control-sm mb-2" placeholder="Remark" id="costApprovalRemark">
                                <button type="button" class="btn btn-sm btn-primary me-2" onclick="saveTarget('costApproval')">Save</button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelTarget('costApproval')">Cancel</button>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <!-- Placeholder -->
                        </div>

                        <!-- Work Completion -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Work Completion</label>
                            <div class="datetime-group">
                                <input type="date" class="form-control form-control-sm" id="workCompletionDate" name="WorkCompletionDate">
                                <input type="time" class="form-control form-control-sm" id="workCompletionTime" name="WorkCompletionTime">
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Target</label>
                            <div id="workCompletionTarget" class="target-time-display" data-target-type="workCompletion">
                                <i class="ti ti-target me-1"></i>
                                <span class="target-date">-</span>
                            </div>
                            <div class="target-change-form" id="workCompletionTargetForm">
                                <input type="datetime-local" class="form-control form-control-sm mb-2" id="workCompletionNewTarget">
                                <input type="text" class="form-control form-control-sm mb-2" placeholder="Remark" id="workCompletionRemark">
                                <button type="button" class="btn btn-sm btn-primary me-2" onclick="saveTarget('workCompletion')">Save</button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelTarget('workCompletion')">Cancel</button>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <!-- Placeholder -->
                        </div>

                        <!-- After Work Follow Up -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">After Work Follow Up</label>
                            <div class="datetime-group">
                                <input type="date" class="form-control form-control-sm" id="afterWorkFollowUpDate" name="AfterWorkFollowUpDate">
                                <input type="time" class="form-control form-control-sm" id="afterWorkFollowUpTime" name="AfterWorkFollowUpTime">
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">Target</label>
                            <div id="afterWorkTarget" class="target-time-display" data-target-type="afterWork">
                                <i class="ti ti-target me-1"></i>
                                <span class="target-date">-</span>
                            </div>
                            <div class="target-change-form" id="afterWorkTargetForm">
                                <input type="datetime-local" class="form-control form-control-sm mb-2" id="afterWorkNewTarget">
                                <input type="text" class="form-control form-control-sm mb-2" placeholder="Remark" id="afterWorkRemark">
                                <button type="button" class="btn btn-sm btn-primary me-2" onclick="saveTarget('afterWork')">Save</button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelTarget('afterWork')">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- After Work Follow Up Summary -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-1">After Work Follow Up Summary</h5>
                    <p class="text-muted mb-0 small">Summary after work completion</p>
                </div>
                <div class="card-body">
                    <textarea class="form-control form-control-sm"
                              id="followUpSummary"
                              name="FollowUpSummary"
                              rows="4"
                              placeholder="Write the follow up summary here..."></textarea>
                </div>
            </div>

            <!-- Feedback -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-1">Feedback</h5>
                    <p class="text-muted mb-0 small">Customer or requestor feedback</p>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Feedback Status</label>
                        <select class="form-select form-select-sm"
                                id="feedbackStatus"
                                name="FeedbackStatus"
                                data-searchable="true"
                                data-placeholder="No Feedback"
                                data-search-placeholder="Search status...">
                            <option value="">No Feedback</option>
                            <!-- Options loaded dynamically via JavaScript -->
                        </select>
                    </div>
                    <textarea class="form-control form-control-sm"
                              id="feedbackSummary"
                              name="FeedbackSummary"
                              rows="4"
                              placeholder="Write the feedback summary here..."></textarea>
                </div>
            </div>

            <!-- Related Documents -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-1">Related Documents</h5>
                    <p class="text-muted mb-0 small">Upload related documents or files</p>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex gap-2 align-items-center">
                            <input type="file" class="form-control form-control-sm" id="relatedDocuments" multiple accept="*/*">
                            <button type="button" class="btn btn-sm btn-primary" id="uploadDocumentBtn">
                                Upload
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="ti ti-arrow-right me-1"></i>
                            Search or drag and drop your file to 'Browse' or 'Choose File' field above
                        </small>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered table-sm" id="relatedDocumentsTable">
                            <thead>
                                <tr>
                                    <th>Document Label</th>
                                    <th>File</th>
                                    <th width="10%">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        <em>No File</em>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="setWorkUpdateEmail" name="SetWorkUpdateEmail">
                        <label class="form-check-label" for="setWorkUpdateEmail">
                            Set Work Update Email
                        </label>
                    </div>
                </div>
            </div>

            <!-- Related Asset -->
            <div class="card mb-3">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">Related Asset</h5>
                            <p class="text-muted mb-0 small">Link assets to this work request</p>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" id="addAssetBtn">
                            <i class="ti ti-plus me-1"></i>
                            Add New Asset
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm" id="relatedAssetTable">
                            <thead>
                                <tr>
                                    <th width="5%">No.</th>
                                    <th>Asset Label</th>
                                    <th>Asset Name</th>
                                    <th width="10%">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="4" class="text-center text-muted">
                                        <em>No Related Asset</em>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <a href="/Helpdesk/Index" class="btn btn-outline-secondary">
                            <i class="ti ti-x me-1"></i>
                            Cancel
                        </a>
                        <!--draft button is not yet implemented-->
                        @* <div>
                            <button type="button" class="btn btn-outline-primary me-2" id="saveDraftBtn">
                                <i class="ti ti-device-floppy me-1"></i>
                                Save as Draft
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="ti ti-check me-1"></i>
                                Submit Work Request
                            </button>
                        </div> *@
                    </div>
                </div>
            </div>

            <!-- Hidden fields for target change notes -->
            <input type="hidden" id="helpdeskResponseTargetChangeNote" name="HelpdeskResponseTargetChangeNote">
            <input type="hidden" id="onsiteResponseTargetChangeNote" name="OnsiteResponseTargetChangeNote">
            <input type="hidden" id="quotationSubmissionTargetChangeNote" name="QuotationSubmissionTargetChangeNote">
            <input type="hidden" id="costApprovalTargetChangeNote" name="CostApprovalTargetChangeNote">
            <input type="hidden" id="workCompletionTargetChangeNote" name="WorkCompletionTargetChangeNote">
            <input type="hidden" id="followUpTargetChangeNote" name="FollowUpTargetChangeNote">
        </form>
    </div>
</div>

<!-- Labor/Material Modal -->
<div class="modal fade" id="laborMaterialModal" tabindex="-1" aria-labelledby="laborMaterialModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="laborMaterialModalLabel">Labor/Material</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Mode Selection -->
                <div class="mb-3">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="laborMaterialMode" id="modeJobCode" value="jobCode" checked>
                        <label class="form-check-label" for="modeJobCode">
                            Search from Job Code
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="laborMaterialMode" id="modeAdHoc" value="adHoc">
                        <label class="form-check-label" for="modeAdHoc">
                            Add new Ad hoc Labor/Material
                        </label>
                    </div>
                </div>

                <!-- Job Code Mode -->
                <div id="jobCodeMode">
                    <div class="mb-3">
                        <label class="form-label fw-semibold required-field">Name</label>
                        <input type="text" class="form-control form-control-sm" id="jobCodeSearch" placeholder="Type the name here to search Job Code..." autocomplete="off">
                        <div id="jobCodeDropdown" class="typeahead-dropdown"></div>
                        <div id="jobCodeSelected" class="mt-2" style="display: none;">
                            <div class="alert alert-info d-flex justify-content-between align-items-center mb-0">
                                <div>
                                    <strong id="selectedJobCodeName"></strong><br>
                                    <small class="text-muted">Remaining Stock: <span id="selectedJobCodeStock"></span></small>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger" id="removeJobCodeBtn">
                                    <i class="ti ti-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold required-field">Transaction Date</label>
                        <input type="date" class="form-control form-control-sm" id="jobCodeTransactionDate">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold required-field">Quantity</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control form-control-sm" id="jobCodeQuantity" min="0.01" step="0.01" value="1.00">
                            <span class="input-group-text" id="jobCodeUnit">PCS</span>
                        </div>
                    </div>
                </div>

                <!-- Ad Hoc Mode -->
                <div id="adHocMode" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label fw-semibold required-field">Name</label>
                        <input type="text" class="form-control form-control-sm" id="adHocName" placeholder="Enter labor/material name">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold required-field">Labor/Material?</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="adHocLabel" id="labelLabor" value="labor" checked>
                                <label class="form-check-label" for="labelLabor">Labor</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="adHocLabel" id="labelBoth" value="both">
                                <label class="form-check-label" for="labelBoth">Labor & Material</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="adHocLabel" id="labelMaterial" value="material">
                                <label class="form-check-label" for="labelMaterial">Material</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold required-field">Unit Price</label>
                        <div class="input-group input-group-sm">
                            <select class="form-select form-select-sm" id="adHocCurrency" style="max-width: 100px;">
                                <option value="">IDR</option>
                            </select>
                            <input type="number" class="form-control form-control-sm" id="adHocUnitPrice" min="0" step="0.01" placeholder="0.00">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold required-field">Measurement Unit</label>
                        <select class="form-select form-select-sm" id="adHocMeasurementUnit">
                            <option value="">Select unit</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold required-field">Quantity</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control form-control-sm" id="adHocQuantity" min="0.01" step="0.01" value="1.00">
                            <span class="input-group-text">UNIT</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                    <i class="ti ti-refresh"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary btn-sm" id="saveLaborMaterialBtn">
                    <i class="ti ti-device-floppy"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Related Asset Modal -->
<div class="modal fade" id="relatedAssetModal" tabindex="-1" aria-labelledby="relatedAssetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="relatedAssetModalLabel">Related Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Search Mode Selection -->
                <div class="mb-3">
                    <label class="form-label fw-semibold required-field">Name</label>
                    <div class="mb-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="assetSearchMode" id="searchIndividual" value="individual" checked>
                            <label class="form-check-label" for="searchIndividual">
                                Search Asset Individually
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="assetSearchMode" id="searchGroup" value="group">
                            <label class="form-check-label" for="searchGroup">
                                Search by Asset Group
                            </label>
                        </div>
                    </div>

                    <!-- Individual Search -->
                    <div id="individualSearchMode">
                        <input type="text" class="form-control form-control-sm" id="assetIndividualSearch" placeholder="Type to search asset..." autocomplete="off">
                        <div id="assetIndividualDropdown" class="typeahead-dropdown"></div>
                        <div id="assetIndividualSelected" class="mt-2" style="display: none;">
                            <div class="alert alert-info d-flex justify-content-between align-items-center mb-0">
                                <div>
                                    <strong id="selectedAssetName"></strong>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger" id="removeAssetIndividualBtn">
                                    <i class="ti ti-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Group Search -->
                    <div id="groupSearchMode" style="display: none;">
                        <input type="text" class="form-control form-control-sm" id="assetGroupSearch" placeholder="Type to search asset group..." autocomplete="off">
                        <div id="assetGroupDropdown" class="typeahead-dropdown"></div>
                        <div id="assetGroupSelected" class="mt-2" style="display: none;">
                            <div class="alert alert-info mb-0">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <strong>Selected Assets:</strong>
                                    <button type="button" class="btn btn-sm btn-danger" id="removeAssetGroupBtn">
                                        <i class="ti ti-trash"></i> Delete
                                    </button>
                                </div>
                                <ol id="selectedAssetGroupList" class="mb-0 ps-3">
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                    <i class="ti ti-refresh"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary btn-sm" id="saveAssetBtn">
                    <i class="ti ti-device-floppy"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Worker Modal -->
<div class="modal fade" id="addWorkerModal" tabindex="-1" aria-labelledby="addWorkerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addWorkerModalLabel">Add Worker</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold required-field">Worker Source</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="workerSource" id="sourceCompany" value="company" checked>
                            <label class="form-check-label" for="sourceCompany">Company Worker</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="workerSource" id="sourceServiceProvider" value="serviceProvider">
                            <label class="form-check-label" for="sourceServiceProvider">Service Provider Worker</label>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold required-field">Worker Name</label>
                    <input type="text" class="form-control form-control-sm" id="workerSearchModal" placeholder="Type to search worker..." autocomplete="off">
                    <div id="workerSearchDropdownModal" class="typeahead-dropdown"></div>
                    <input type="hidden" id="selectedWorkerId">
                    <input type="hidden" id="selectedWorkerSide">
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="joinChatRoomCheck" value="true">
                        <label class="form-check-label" for="joinChatRoomCheck">
                            Join to External Chat Room
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                    <i class="ti ti-refresh"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary btn-sm" id="saveWorkerBtn">
                    <i class="ti ti-device-floppy"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="~/assets/js/plugins/datepicker-full.min.js"></script>
    <script src="~/assets/js/components/searchable-dropdown.js"></script>
    <script src="~/assets/js/pages/workrequest/work-request-add.js"></script>
    <script src="~/assets/js/pages/workrequest/work-request-add-extended.js"></script>
}
