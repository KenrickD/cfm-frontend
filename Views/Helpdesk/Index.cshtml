@model cfm_frontend.ViewModels.WorkRequestViewModel

@{
    ViewBag.Title = "Work Request Management";
    ViewBag.pTitle = "Helpdesk";
    ViewBag.cTitle = "List of Work Request";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section styles {
    <link href="~/assets/css/plugins/animate.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="~/assets/css/uikit.css">

    <style>
        .modal-footer.no-divider {
            border-top: none;
        }

        .modal-header.no-divider {
            border-bottom: none;
        }
        .page-link {
            cursor: pointer;
        }
    </style>
}

<div class="row">
    <div class="col-sm-12">
        <div class="card">
            <div class="card-header">
                <h5>@ViewBag.cTitle</h5>
                <p>This table shows all work requests with their codes, titles, requestors, and related details.</p>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <div class="grid gap-0 column-gap-2 d-flex flex-row" style="100%">
                        <div class="input-group w-100" style="border-color: #DBE0E5;">
                            <input placeholder="Search by entering keywords for Work Request Code, Work Title..." class="form-control" type="text" style="width: 100%; border-color: #DBE0E5;" />
                        </div>
                        <div class="d-flex flex-row justify-content-end w-25">
                            <a href="#" class="btn btn-primary d-flex align-items-center justify-content-center" data-bs-toggle="tooltip" data-bs-placement="top" title="Search">
                                <i class="feather icon-search"></i>
                            </a>
                            <a href="#" class="btn btn-secondary d-flex align-items-center justify-content-center" data-bs-toggle="tooltip" data-bs-placement="top" title="Clear Search">
                                <i class="feather icon-refresh-cw"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="row g-2">
                        <div class="col-md-2">
                            <div class="input-group search-form">
                                <select class="form-control" data-trigger id="filter_status">
                                    <option selected>Select Status</option>
                                    @if (Model.Status != null)
                                    {
                                        foreach (var s in Model.Status)
                                        {
                                            <option value="@s.id">@s.status</option>
                                        }
                                    }
                                    <option value="1">Open</option>
                                    <option value="2">Closed</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="input-group search-form">
                                <select class="form-control" data-trigger id="filter_property_group">
                                    <option selected>Select Property Group</option>
                                    @if (Model.PropertyGroups != null)
                                    {
                                        foreach (var pg in Model.PropertyGroups)
                                        {
                                            <option value="@pg.propertyGroupId">@pg.propertyGroupName</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group" id="datepicker_range">
                                <input type="text" class="form-control text-center" placeholder="Select date range" readonly>
                            </div>
                        </div>
                        <div class="col-md-2 d-grid">
                            <button class="btn btn-success d-flex align-items-center justify-content-center">Filter</button>
                        </div>
                        <div class="col-md-2 d-grid">
                            <a href="@Url.Action("WorkRequestCreate", "Helpdesk")" class="btn btn-primary d-flex align-items-center justify-content-center">
                                <i class="feather icon-plus me-2"></i> Create Ticket
                            </a>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Work Request Code</th>
                                <th>Request Date</th>
                                <th>Work Title</th>
                                <th>Status</th>
                                <th>Work Category</th>
                                <th>Location</th>
                                <th>Assigned By</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.WorkRequest != null && Model.WorkRequest.Any())
                            {
                                // Calculate starting index: (Page 1 -> 1, Page 2 -> 11, etc.)
                                int i = ((Model.CurrentPage - 1) * Model.PageSize) + 1;

                                foreach (var item in Model.WorkRequest)
                                {
                                    <tr>
                                        <td>@i</td>
                                        <td>
                                            <a href="@Url.Action("WorkRequestDetails", "Helpdesk", new { id = item.idWorkRequest })" class="text-secondary fw-bold">
                                                @item.workRequestCode
                                            </a>
                                        </td>
                                        <td>@item.requestDate</td>
                                        <td>
                                            <span class="d-block text-truncate" style="max-width: 150px;" title="@item.workTitle">
                                                @item.workTitle
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge" style="background-color: @item.statusColor; color: #fff;">@item.status</span>
                                        </td>
                                        <td>@item.workCategory</td>
                                        <td>@item.locationFinal</td>
                                        <td>
                                            @item.assignedBy
                                            @if (!string.IsNullOrEmpty(item.assignedDate))
                                            {
                                                <br />
                                    
                                                <small class="text-muted">@item.assignedDate</small>
                                            }
                                        </td>
                                        <td>
                                            <div class="d-inline-flex gap-1">
                                                <a href="@Url.Action("WorkRequestDetails", "Helpdesk", new { id = item.idWorkRequest })" class="btn btn-sm btn-icon btn-outline-primary" title="View">
                                                    <i class="feather icon-eye"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-icon btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" data-pc-animate="fade-in-scale" title="Delete">
                                                    <i class="feather icon-trash-2"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    i++;
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <div class="d-flex flex-column align-items-center">
                                            <i class="feather icon-inbox text-muted mb-2" style="font-size: 2rem;"></i>
                                            <h6 class="text-muted">No work requests found</h6>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (Model.TotalItems > 0)
                {
                    <div class="row align-items-center mt-3">
                        <div class="col-md-6">
                            <p class="mb-0 text-muted">
                                Showing
                                <strong>@(((Model.CurrentPage - 1) * Model.PageSize) + 1)</strong>
                                to
                                <strong>@(Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalItems))</strong>
                                of
                                <strong>@Model.TotalItems</strong> entries
                            </p>
                        </div>
                        <div class="col-md-6">
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-end mb-0">
                                    <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                                        <a class="page-link" href="@Url.Action("Index", new { page = Model.CurrentPage - 1, pagesize = Model.PageSize })" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>

                                    @for (int p = 1; p <= Model.TotalPages; p++)
                                    {
                                        @if (p == 1 || p == Model.TotalPages || (p >= Model.CurrentPage - 2 && p <= Model.CurrentPage + 2))
                                        {
                                            <li class="page-item @(p == Model.CurrentPage ? "active" : "")">
                                                <a class="page-link" href="@Url.Action("Index", new { page = p, pagesize = Model.PageSize })">@p</a>
                                            </li>
                                        }
                                        else if (p == Model.CurrentPage - 3 || p == Model.CurrentPage + 3)
                                        {
                                            <li class="page-item disabled"><span class="page-link">...</span></li>
                                        }
                                    }

                                    <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                                        <a class="page-link" href="@Url.Action("Index", new { page = Model.CurrentPage + 1, pagesize = Model.PageSize })" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this item? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="~/assets/js/plugins/choices.min.js"></script>
    <script>
        // Initialize choices for filters
        document.addEventListener('DOMContentLoaded', function () {
            var genericExamples = document.querySelectorAll('[data-trigger]');
            for (i = 0; i < genericExamples.length; ++i) {
                var element = genericExamples[i];
                new Choices(element, {
                    placeholderValue: 'This is a placeholder set in the config',
                    searchPlaceholderValue: 'Type to search',
                });
            }
        });
    </script>

    <script src="~/assets/js/plugins/datepicker-full.min.js"></script>
    <script>
        // Initialize Date Range Picker
        (function () {
            const d_week = new Datepicker(document.querySelector('#datepicker_range'), {
                buttonClass: 'btn',
                rangePicker: true
            });
        })();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            var deleteModal = $('#deleteModal');
            deleteModal.on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var recipient = button.data('pc-animate');
                var modalTitle = deleteModal.find('.modal-title');
                // Optional: Update title or add specific ID to delete button
                // modalTitle.text('Delete Item ' + button.data('id'));
                deleteModal.addClass('anim-' + recipient);
                if (recipient == 'let-me-in' || recipient == 'make-way' || recipient == 'slip-from-top') {
                    $('body').addClass('anim-' + recipient);
                }
            });
            deleteModal.on('hidden.bs.modal', function () {
                removeClassByPrefix(deleteModal, 'anim-');
                removeClassByPrefix($('body'), 'anim-');
            });
            function removeClassByPrefix(node, prefix) {
                node.removeClass(function (index, className) {
                    return (className.match(new RegExp('\\b' + prefix + '\\S+', 'g')) || []).join(' ');
                });
            }
        });
    </script>
}